<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OPTICAL SUITE // LAVAL SOFTWARE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #050510;
            --glass: rgba(20, 20, 35, 0.95);
            --glass-border: rgba(255, 255, 255, 0.1);
            --neon-cyan: #00f3ff;
            --neon-pink: #bc13fe;
            --neon-green: #0f0;
            --neon-orange: #ff9d00;
            --text-main: #e0e0e0;
            --text-dim: #8b9bb4;
        }

        body {
            background-color: var(--bg-dark);
            background-image: 
                linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            color: var(--text-main);
            font-family: 'Rajdhani', sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow-x: hidden;
        }

        .main-wrapper {
            width: 100%;
            max-width: 1400px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .nav-tabs { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; }
        .tab-btn {
            background: rgba(0,0,0,0.5); border: 1px solid var(--glass-border); color: var(--text-dim);
            padding: 15px 30px; font-family: 'Orbitron'; font-size: 1rem; cursor: pointer; transition: 0.3s;
            clip-path: polygon(15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%, 0 15px);
            text-align: center;
        }
        .tab-btn.active { background: var(--neon-cyan); color: #000; font-weight: bold; box-shadow: 0 0 20px rgba(0, 243, 255, 0.3); }

        .interface-container {
            background: var(--glass); backdrop-filter: blur(20px); border: 1px solid var(--glass-border);
            border-radius: 4px; box-shadow: 0 0 50px rgba(0, 0, 0, 0.9); display: none;
            grid-template-columns: 360px 1fr; overflow: hidden; min-height: 850px;
            clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px);
        }
        .interface-container.active { display: grid; }
        
        #course.interface-container.active { display: block; padding: 40px; overflow-y: auto; }

        /* Controles */
        .controls {
            padding: 30px; border-right: 1px solid var(--glass-border); background: rgba(0, 0, 0, 0.3);
            display: flex; flex-direction: column; gap: 15px; overflow-y: auto; z-index: 2;
        }
        .brand { font-family: 'Orbitron', sans-serif; font-size: 1.5rem; color: #fff; border-bottom: 2px solid var(--neon-cyan); padding-bottom: 15px; margin-bottom: 10px; }
        .brand span { color: var(--neon-pink); }

        .input-group label { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-dim); margin-bottom: 5px; text-transform: uppercase; }
        .input-group input, .input-group select { width: 100%; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--glass-border); color: #fff; padding: 12px; font-family: 'Orbitron'; font-size: 1rem; }
        .input-group input:disabled { background: rgba(0,0,0,0.5); color: #555; cursor: not-allowed; }

        .mode-switch { display: flex; background: rgba(0,0,0,0.5); padding: 4px; border-radius: 4px; margin-bottom: 10px; }
        .mode-option { flex: 1; text-align: center; padding: 8px; font-size: 0.75rem; cursor: pointer; color: var(--text-dim); font-family: 'Orbitron'; }
        .mode-option.active { background: var(--neon-pink); color: white; font-weight: bold; }

        .btn-action { background: linear-gradient(90deg, var(--neon-cyan), #0088ff); color: #000; border: none; padding: 15px; font-family: 'Orbitron'; font-weight: bold; cursor: pointer; margin-top: auto; text-transform: uppercase; }
        .btn-action:hover { box-shadow: 0 0 20px var(--neon-cyan); letter-spacing: 2px; }
        
        .btn-pdf { background: #fff; color: #000; border: none; padding: 15px; font-family: 'Orbitron'; font-weight: bold; cursor: pointer; margin-top: 10px; text-transform: uppercase; }
        .btn-pdf:hover { background: #eee; box-shadow: 0 0 15px #fff; }

        .btn-auto { background: transparent; border: 1px solid var(--neon-pink); color: var(--neon-pink); padding: 10px; font-family: 'Orbitron'; font-size: 0.8rem; cursor: pointer; width: 100%; transition: 0.3s; }
        .btn-auto:hover { background: var(--neon-pink); color: #fff; box-shadow: 0 0 15px var(--neon-pink); }
        .auto-group { display: flex; gap: 10px; align-items: flex-end; margin-bottom: 15px; }
        .input-small { width: 80px !important; text-align: center; }

        .results-panel { padding: 40px; position: relative; background: radial-gradient(circle at top right, rgba(0,50,100,0.15), transparent); overflow-y: auto; display: flex; flex-direction: column; }

        /* Styles sp√©cifiques au Cours */
        .course-content { max-width: 900px; margin: 0 auto; color: #e0e0e0; line-height: 1.6; }
        .course-header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid var(--neon-cyan); padding-bottom: 20px; margin-bottom: 40px; }
        .course-title { font-family: 'Orbitron'; font-size: 2.5rem; color: #fff; line-height: 1.1; }
        .course-author { color: var(--text-dim); font-family: 'Rajdhani'; font-size: 1.2rem; margin-top: 5px; font-style: italic; }
        .chapter { margin-bottom: 50px; background: rgba(255,255,255,0.02); padding: 30px; border-radius: 8px; border-left: 4px solid var(--neon-pink); }
        .chapter h2 { font-family: 'Orbitron'; color: var(--neon-cyan); margin-top: 0; }
        .chapter h3 { color: var(--neon-orange); margin-top: 20px; }
        .formula-box { background: rgba(0,0,0,0.5); padding: 20px; border-radius: 8px; font-family: 'Courier New', monospace; margin: 20px 0; border: 1px solid var(--glass-border); text-align: center; font-size: 1.1rem; color: var(--neon-green); }
        .example-box { background: rgba(255, 157, 0, 0.1); border: 1px dashed var(--neon-orange); padding: 20px; border-radius: 8px; }
        .variable { color: var(--neon-pink); font-weight: bold; }
        
        /* Blueprint & Viz */
        .blueprint-wrapper {
            position: relative; width: 100%; height: 450px; background: #080810;
            border: 1px solid var(--glass-border); margin-bottom: 20px; overflow: hidden; 
        }
        #blueprint-canvas { width: 100%; height: 100%; display: block; cursor: grab; }
        #blueprint-canvas:active { cursor: grabbing; }
        .zoom-controls { position: absolute; bottom: 20px; right: 20px; display: flex; gap: 5px; }
        .zoom-btn { width: 30px; height: 30px; background: rgba(0,0,0,0.7); color: #fff; border: 1px solid var(--neon-cyan); font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .zoom-btn:hover { background: var(--neon-cyan); color: #000; }

        .arch-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .mirror-card { background: rgba(255,255,255,0.02); border: 1px solid var(--glass-border); padding: 25px; }
        .mirror-card h3 { margin: 0 0 20px 0; font-family: 'Orbitron'; font-size: 1rem; color: var(--text-dim); border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px;}
        .res-val { font-family: 'Orbitron'; color: #fff; font-size: 1.2rem; text-align: right; }
        .result-row { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 5px; font-size: 0.9rem;}

        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .data-table th { text-align: left; color: var(--text-dim); padding: 10px; border-bottom: 1px solid var(--neon-cyan); }
        .data-table td { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }

        .footer-brand { position: fixed; bottom: 10px; right: 20px; font-family: 'Orbitron'; font-size: 0.7rem; color: rgba(255,255,255,0.3); }
        #an-info { margin-bottom: 20px; display: flex; gap: 20px; font-size: 0.9rem; color: var(--text-dim); }
        #an-info span { color: #fff; font-family: 'Orbitron'; margin-left: 5px; }
    </style>
</head>
<body>

<div class="main-wrapper">
    <div class="nav-tabs">
        <div class="tab-btn active" onclick="switchTab('analyzer')">ANALYSEUR CAUSTIQUE</div>
        <div class="tab-btn" onclick="switchTab('architect')">ARCHITECTE OPTIQUE</div>
        <div class="tab-btn" onclick="switchTab('course')">COURS & TH√âORIE</div>
    </div>

    <!-- MODULE 1: ANALYZER -->
    <div id="analyzer" class="interface-container active">
        <div class="controls">
            <div class="brand">CAUSTIQUE <span>v24</span></div>
            
            <div class="input-group">
                <label>Type de Miroir</label>
                <select id="an-type" onchange="updateAnalyzerK(); runAnalyzer()">
                    <option value="parabola" selected>Parabole (K = -1)</option>
                    <option value="hyperbola">Hyperbole (K < -1)</option>
                    <option value="sphere">Sph√®re (K = 0)</option>
                    <option value="ellipse">Ellipse (-1 < K < 0)</option>
                    <option value="custom">Personnalis√©</option>
                </select>
            </div>

            <div class="input-group"><label>Diam√®tre Miroir (mm)</label><input type="number" id="an-diameter" value="300" oninput="runAnalyzer()"></div>
            <div class="input-group"><label>Trou Central (mm)</label><input type="number" id="an-hole" value="0" placeholder="0" oninput="runAnalyzer()"></div>
            <div class="input-group"><label>Rayon Courbure (R)</label><input type="number" id="an-radius" value="6200" step="0.1" oninput="runAnalyzer()"></div>
            
            <div class="input-group">
                <label>Constante (K)</label>
                <input type="number" id="an-kfactor" value="-1" step="0.0001" disabled oninput="runAnalyzer()">
            </div>
            
            <label style="color:var(--text-dim); font-size:0.8rem; margin-top:10px; display:block;">G√âN√âRATEUR DE ZONES</label>
            <div class="auto-group">
                <div style="flex:1">
                    <label style="font-size:0.6rem">NB. ZONES</label>
                    <input type="number" id="an-nb-zones" class="input-small" placeholder="Auto">
                </div>
                <button class="btn-auto" onclick="autoCalcZones()">CALCULER ZONES</button>
            </div>

            <div class="input-group">
                <label>Liste Rayons (mm)</label>
                <!-- onchange pour √©viter le clignotement pendant la frappe, ou onblur -->
                <input type="text" id="an-zones" value="50, 100, 140, 200" onchange="runAnalyzer()">
            </div>
            
            <!-- Bouton "Lancer Analyse" supprim√© car automatique -->
        </div>
        <div class="results-panel">
            <div id="an-info">
                <div>F/D: <span id="an-fd">-</span></div>
                <div>Largeur Zone Max: <span id="an-maxw" style="color:var(--neon-pink)">-</span></div>
            </div>
            <canvas id="visualizer" style="width:100%; height:120px; background:rgba(0,0,0,0.2); border:1px solid #333; margin-bottom:20px;"></canvas>
            <table class="data-table">
                <thead><tr><th>ZONE</th><th>RAYON (S)</th><th>PROF. (Z)</th><th>AXIAL (Y)</th><th>TRANSV. (X)</th></tr></thead>
                <tbody id="an-results"></tbody>
            </table>
        </div>
    </div>

    <!-- MODULE 2: ARCHITECT -->
    <div id="architect" class="interface-container">
        <div class="controls">
            <div class="brand">ARCHITECT <span>PRO</span></div>
            
            <div class="input-group">
                <label>Architecture</label>
                <select id="arch-type" onchange="updateArchUI()">
                    <option value="newton">Newton (Parabolique)</option>
                    <option value="cassegrain">Cassegrain Classique</option>
                    <option value="dk">Dall-Kirkham (DK)</option>
                    <option value="rc" selected>Ritchey-Chr√©tien (RC)</option>
                    <option value="sct">Schmidt-Cassegrain (SCT)</option>
                </select>
            </div>

            <div class="input-group"><label>Diam√®tre (D) mm</label><input type="number" id="arch-D" value="300"></div>
            <div class="input-group"><label>Focale Syst√®me (F) mm</label><input type="number" id="arch-F" value="4500"></div>
            <div class="input-group"><label>Back Focus (B) mm</label><input type="number" id="arch-B" value="300"></div>

            <div id="calc-mode-container">
                <label style="color:var(--text-dim); font-size:0.7rem; margin-bottom:5px;">CONTRAINTE</label>
                <div class="mode-switch">
                    <div class="mode-option active" id="mode-f1" onclick="setCalcMode('f1')">FIXER FOCALE F1</div>
                    <div class="mode-option" id="mode-sep" onclick="setCalcMode('sep')">FIXER S√âPARATION</div>
                </div>
            </div>

            <div class="input-group"><label>Focale Primaire (F1) <span id="lock-f1">üîí</span></label><input type="number" id="arch-F1" value="900"></div>
            <div class="input-group"><label>S√©paration (d) <span id="lock-sep" style="display:none">üîí</span></label><input type="number" id="arch-Sep" value="650" disabled></div>

            <button class="btn-action" onclick="runArchitect()">CALCULER & DESSINER</button>
            
            <div class="pdf-group" style="margin-top:20px; border-top:1px solid rgba(255,255,255,0.1); padding-top:20px;">
                <div class="input-group">
                    <label>Nom du Projet</label>
                    <input type="text" id="project-name" placeholder="Ex: Mon Dall-Kirkham 300">
                </div>
                <button class="btn-pdf" onclick="downloadPDF()">T√âL√âCHARGER LE PLAN (PDF)</button>
            </div>
        </div>

        <div class="results-panel">
            <div style="font-family:'Orbitron'; font-size:1.2rem; color:var(--text-dim); margin-bottom:10px;">PLAN TECHNIQUE</div>
            
            <div class="blueprint-wrapper">
                <canvas id="blueprint-canvas"></canvas>
                <div class="zoom-controls">
                    <div class="zoom-btn" onclick="zoomBlueprint(0.1)">+</div>
                    <div class="zoom-btn" onclick="zoomBlueprint(-0.1)">-</div>
                    <div class="zoom-btn" onclick="resetZoom()">R</div>
                </div>
            </div>
            
            <div style="display:flex; justify-content:space-between; margin-bottom:20px; border-bottom:1px solid var(--glass-border); padding-bottom:10px;">
                <div><div style="font-size:0.8rem; color:var(--text-dim)">OUVERTURE</div><div style="font-family:'Orbitron'; font-size:1.2rem; color:#fff" id="res-fd">-</div></div>
                <div><div style="font-size:0.8rem; color:var(--text-dim)">GRANDISSEMENT</div><div style="font-family:'Orbitron'; font-size:1.2rem; color:#fff" id="res-mag">-</div></div>
                <div><div style="font-size:0.8rem; color:var(--text-dim)">OBSTRUCTION</div><div style="font-family:'Orbitron'; font-size:1.2rem; color:#fff" id="res-obst">-</div></div>
                <div><div style="font-size:0.8rem; color:var(--text-dim)">DIAM√àTRE PUR</div><div style="font-family:'Orbitron'; font-size:1.2rem; color:var(--neon-cyan)" id="res-d-eff">-</div></div>
            </div>

            <div class="arch-grid">
                <div class="mirror-card">
                    <h3 style="color:var(--neon-orange)">MIROIR PRIMAIRE</h3>
                    <div class="result-row"><span>Rayon Courbure (R1)</span><div class="res-val" id="res-r1">-</div></div>
                    <div class="result-row"><span>Focale (F1)</span><div class="res-val" id="res-f1-out">-</div></div>
                    <div class="result-row"><span>Constante (K1)</span><div class="res-val" id="res-k1">-</div></div>
                    <div class="result-row"><span>Forme</span><div class="res-val" id="res-shape1" style="font-size:0.8rem">-</div></div>
                    <div class="result-row"><span>Trou Central (Min)</span><div class="res-val" id="res-hole" style="color:var(--neon-pink)">-</div></div>
                </div>

                <div class="mirror-card" id="sec-card">
                    <h3 style="color:var(--neon-green)">MIROIR SECONDAIRE</h3>
                    <div class="result-row"><span>Rayon Courbure (R2)</span><div class="res-val" id="res-r2">-</div></div>
                    <div class="result-row"><span>S√©paration (d)</span><div class="res-val" id="res-sep-out">-</div></div>
                    <div class="result-row"><span>Constante (K2)</span><div class="res-val" id="res-k2">-</div></div>
                    <div class="result-row"><span>Diam√®tre Optique</span><div class="res-val" id="res-d2">-</div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODULE 3: COURS & TH√âORIE -->
    <div id="course" class="interface-container">
        <div class="course-content" id="course-text">
            <div class="course-header">
                <div>
                    <div class="course-title">COURS D'OPTIQUE APPLIQU√âE</div>
                    <div class="course-author">R√©dig√© par Ludovic Laval</div>
                </div>
                <button class="btn-pdf" style="width:auto; margin:0;" onclick="downloadCoursePDF()">T√âL√âCHARGER LE COURS (PDF)</button>
            </div>

            <div class="chapter">
                <h2>1. LE TEST DE LA CAUSTIQUE</h2>
                <h3>Le Probl√®me de l'Aberration Sph√©rique</h3>
                <p>Un miroir sph√©rique focalise tous les rayons en un point unique (le centre de courbure). Mais pour un t√©lescope, nous utilisons souvent des formes <strong>Paraboliques</strong> ou <strong>Hyperboliques</strong> pour corriger les images venues de l'infini.</p>
                <p>Ces miroirs asph√©riques n'ont pas un rayon de courbure constant. Le "centre" varie selon la zone du miroir. L'ensemble de ces centres forme une courbe appel√©e <strong>La Caustique</strong>.</p>
                
                <h3>La M√©thode Platzeck-Gaviola</h3>
                <p>Ce logiciel utilise les √©quations d√©riv√©es par <em>Cornejo & Malacara (1978)</em> pour calculer o√π placer l'appareil de contr√¥le (Foucault) pour chaque zone du miroir.</p>
                
                <div class="formula-box">
                    Donn√©es d'Entr√©e :<br>
                    R = Rayon de Courbure au centre<br>
                    K = Constante Conique<br>
                    S = Hauteur de la Zone (distance au centre)
                </div>
            </div>

            <div class="chapter">
                <h2>2. LES FORMULES MATH√âMATIQUES</h2>
                <p>Voici comment le logiciel fonctionne "sous le capot". Vous pouvez utiliser ces formules pour v√©rifier les r√©sultats √† la main. Ces √©quations sont les solutions analytiques <strong>exactes</strong> et non des approximations.</p>

                <h3>√âtape 1 : La Courbure (c)</h3>
                <div class="formula-box">c = 1 / R</div>

                <h3>√âtape 2 : La Fl√®che (z) - "Sagitta"</h3>
                <p>C'est la profondeur du miroir √† la hauteur S.</p>
                <div class="formula-box">
                    z = (c * S¬≤) / (1 + ‚àö(1 - (K+1) * c¬≤ * S¬≤))
                </div>

                <h3>√âtape 3 : Coordonn√©es de la Caustique (X, Y)</h3>
                <p>Le logiciel calcule deux valeurs. <strong>Y</strong> est la position longitudinale (avant/arri√®re) et <strong>X</strong> est la position transversale (lat√©rale).</p>
                <div class="formula-box">
                    Terme A = c * z * (K + 1)<br><br>
                    Y = -K * z * [3 + A * (A - 3)]<br>
                    X = -2 * S * c * K * z * [2 + A * (A - 3)] / (1 - A)
                </div>
            </div>

            <div class="chapter">
                <h2>3. EXEMPLE DE CALCUL √Ä LA MAIN</h2>
                <div class="example-box">
                    <p>Prenons un miroir standard :</p>
                    <ul>
                        <li><strong>R = 6200 mm</strong></li>
                        <li><strong>K = -1</strong> (Parabole)</li>
                        <li>Zone √† tester : <strong>S = 250 mm</strong></li>
                    </ul>
                    
                    <p><strong>1. Calcul de c :</strong><br>
                    c = 1 / 6200 ‚âà 0.00016129</p>

                    <p><strong>2. Calcul de z :</strong><br>
                    Pour K = -1, le terme sous la racine devient 1. La formule se simplifie :<br>
                    z = c * S¬≤ / 2 = 250¬≤ / (2 * 6200) ‚âà <strong>5.0403 mm</strong></p>

                    <p><strong>3. Calcul de A :</strong><br>
                    Comme K+1 = 0, alors <strong>A = 0</strong>.</p>

                    <p><strong>4. Calcul de Y :</strong><br>
                    Y = -(-1) * 5.0403 * [3 + 0] = 5.0403 * 3 = <strong>15.1209 mm</strong></p>

                    <p><strong>5. Calcul de X :</strong><br>
                    X = -2 * 250 * c * (-1) * z * [2] / 1<br>
                    X = 500 * (1/6200) * 5.0403 * 2 ‚âà <strong>0.8129 mm</strong></p>
                    
                    <p style="margin-top:10px; font-weight:bold; color:#fff">
                        R√©sultat du Logiciel : Y=15.121, X=0.813. C'est identique !
                    </p>
                </div>
            </div>
            
            <div class="chapter">
                <h2>4. MODULE ARCHITECTE OPTIQUE</h2>
                <p>Ce module utilise la th√©orie de Schwarzschild du 3√®me ordre pour calculer les miroirs.</p>
                <h3>Dall-Kirkham</h3>
                <p>Pour un DK, on impose que le miroir secondaire soit sph√©rique (<span class="variable">K2=0</span>). Pour corriger l'aberration sph√©rique r√©sultante, le miroir primaire doit √™tre une <strong>Ellipse Prolate</strong>.</p>
                <div class="formula-box">
                    K1 = -1 + [ (M¬≤ - 1) / M¬≥ ] * (Distance Secondaire-Foyer / Focale Primaire)
                </div>
            </div>
        </div>
    </div>
    
    <div class="footer-brand">LAVAL SOFTWARE // OPTICAL SUITE v24</div>
</div>

<script>
    // Variables globales
    let currentData = {};
    let viewState = { scale: 1, offsetX: 0, offsetY: 0, isDragging: false, lastX: 0, lastY: 0 };
    let calculationMode = 'f1';

    // --- ANALYZEUR: CALCUL AUTO ---
    function autoCalcZones() {
        const D = parseFloat(document.getElementById('an-diameter').value);
        const holeD = parseFloat(document.getElementById('an-hole').value) || 0;
        const R = parseFloat(document.getElementById('an-radius').value);
        const forcedN = parseInt(document.getElementById('an-nb-zones').value);
        
        if(!D || !R) { alert("Saisir Diam√®tre et Rayon"); return; }

        const m = (R/2) / D;
        const R_cm = R / 10;
        const term = m * Math.pow(R_cm, 2);
        const width_cm = 4.53 * Math.pow(term, 1/3) * 0.01;
        const width_mm = width_cm * 10;

        const radiusMirror = D / 2;
        let numZones;

        if (forcedN > 0) {
            numZones = forcedN;
        } else {
            numZones = Math.ceil(radiusMirror / width_mm);
            document.getElementById('an-nb-zones').value = numZones; 
        }

        const actualWidth = radiusMirror / numZones;
        let zoneCenters = [];
        
        for(let i=0; i<numZones; i++) {
            let center = (i * actualWidth) + (actualWidth/2);
            // On ajoute la zone seulement si elle est en dehors du trou (+ marge 2mm)
            if(center > (holeD/2 + 2)) {
                zoneCenters.push(center.toFixed(1));
            }
        }

        document.getElementById('an-zones').value = zoneCenters.join(', ');
        document.getElementById('an-fd').innerText = "f/" + m.toFixed(1);
        document.getElementById('an-maxw').innerText = width_mm.toFixed(1) + " mm";
        
        runAnalyzer();
    }

    function updateAnalyzerK() {
        const type = document.getElementById('an-type').value;
        const kInput = document.getElementById('an-kfactor');
        
        if(type === 'custom') {
            kInput.disabled = false;
            kInput.style.backgroundColor = 'rgba(255,255,255,0.15)'; // Highlight
            kInput.focus();
        } else {
            kInput.disabled = true;
            kInput.style.backgroundColor = 'rgba(255,255,255,0.05)';
            
            if(type === 'parabola') kInput.value = -1;
            else if(type === 'sphere') kInput.value = 0;
            else if(type === 'hyperbola') kInput.value = -1.1;
            else if(type === 'ellipse') kInput.value = -0.5;
        }
    }

    // --- BLUEPRINT ZOOM ---
    const canvas = document.getElementById('blueprint-canvas');
    canvas.addEventListener('mousedown', (e) => { viewState.isDragging = true; viewState.lastX = e.clientX; viewState.lastY = e.clientY; });
    window.addEventListener('mouseup', () => { viewState.isDragging = false; });
    canvas.addEventListener('mousemove', (e) => {
        if (!viewState.isDragging) return;
        viewState.offsetX += e.clientX - viewState.lastX;
        viewState.offsetY += e.clientY - viewState.lastY;
        viewState.lastX = e.clientX; viewState.lastY = e.clientY;
        redrawCurrentBlueprint();
    });
    canvas.addEventListener('wheel', (e) => { e.preventDefault(); zoomBlueprint(e.deltaY > 0 ? -0.1 : 0.1); });

    function zoomBlueprint(delta) {
        viewState.scale += delta;
        if(viewState.scale < 0.1) viewState.scale = 0.1;
        if(viewState.scale > 5) viewState.scale = 5;
        redrawCurrentBlueprint();
    }
    function resetZoom() { viewState.scale = 1; viewState.offsetX = 0; viewState.offsetY = 0; redrawCurrentBlueprint(); }
    function redrawCurrentBlueprint() {
        if(!currentData.type) return;
        const ctx = canvas.getContext('2d');
        drawBlueprintGeneric(ctx, canvas.width, canvas.height, currentData.type.toLowerCase(), currentData.D, currentData.F1, currentData.Sep, currentData.B, currentData.D2, currentData.F, currentData.Hole, 'screen');
    }

    // --- UI TABS ---
    function switchTab(tabId) {
        document.querySelectorAll('.interface-container').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        event.target.classList.add('active');
        
        // Refresh canvas size if architect is shown
        if(tabId === 'architect') { 
            const wrap = document.querySelector('.blueprint-wrapper');
            canvas.width = wrap.offsetWidth; 
            canvas.height = wrap.offsetHeight; 
            setTimeout(runArchitect, 50); 
        }
    }

    // --- ARCHITECT LOGIC ---
    function setCalcMode(mode) {
        calculationMode = mode;
        const inpF1 = document.getElementById('arch-F1');
        const inpSep = document.getElementById('arch-Sep');
        const lockF1 = document.getElementById('lock-f1');
        const lockSep = document.getElementById('lock-sep');
        const btnF1 = document.getElementById('mode-f1');
        const btnSep = document.getElementById('mode-sep');
        if(mode === 'f1') {
            btnF1.classList.add('active'); btnSep.classList.remove('active');
            inpF1.disabled = false; inpSep.disabled = true;
            lockF1.style.display = 'inline'; lockSep.style.display = 'none';
        } else {
            btnF1.classList.remove('active'); btnSep.classList.add('active');
            inpF1.disabled = true; inpSep.disabled = false;
            lockF1.style.display = 'none'; lockSep.style.display = 'inline';
        }
    }

    function updateArchUI() {
        const type = document.getElementById('arch-type').value;
        const modeDiv = document.getElementById('calc-mode-container');
        const inpSep = document.getElementById('arch-Sep');
        if(type === 'newton') {
            modeDiv.style.opacity = '0.3'; modeDiv.style.pointerEvents = 'none'; setCalcMode('f1');
            document.getElementById('sec-card').style.opacity = '0.3'; inpSep.value = "0";
        } else {
            modeDiv.style.opacity = '1'; modeDiv.style.pointerEvents = 'all'; document.getElementById('sec-card').style.opacity = '1';
        }
        runArchitect();
    }

    // --- DRAWING ENGINE ---
    function drawBlueprintGeneric(ctx, width, height, type, D, F1, Sep, B, D2, F_sys, holeDiam, theme) {
        ctx.clearRect(0,0, width, height);
        ctx.save();
        if(theme === 'screen') {
            ctx.translate(viewState.offsetX, viewState.offsetY);
            ctx.translate(width/2, height/2);
            ctx.scale(viewState.scale, viewState.scale);
            ctx.translate(-width/2, -height/2);
        }

        const C_M1 = theme==='screen'?"#ff9d00":"#000";
        const C_M2 = theme==='screen'?"#0f0":"#000";
        const C_DIM = theme==='screen'?"#00f3ff":"#444";
        const C_TEXT = theme==='screen'?"#fff":"#000";
        const C_RAY = theme==='screen'?"rgba(0, 243, 255, 0.4)":"#aaa";

        let totalLen = (type === 'newton') ? F1 * 1.3 : (Sep + B) * 1.2;
        let scale = (width - 120) / totalLen; 
        let startX = 60; let axisY = height / 2;

        ctx.beginPath(); ctx.moveTo(-1000, axisY); ctx.lineTo(width+1000, axisY);
        ctx.setLineDash([5, 5]); ctx.strokeStyle = theme==='screen'?"rgba(255,255,255,0.1)":"#ccc"; ctx.stroke(); ctx.setLineDash([]);

        function drawDim(l, x1, x2, y) {
            ctx.beginPath(); ctx.moveTo(x1, y); ctx.lineTo(x2, y);
            ctx.moveTo(x1, y-5); ctx.lineTo(x1, y+5); ctx.moveTo(x2, y-5); ctx.lineTo(x2, y+5);
            ctx.strokeStyle = C_DIM; ctx.lineWidth=1/viewState.scale; ctx.stroke();
            ctx.fillStyle = C_TEXT; ctx.font = theme==='screen'?"12px Orbitron":"10px Helvetica"; ctx.textAlign="center";
            ctx.fillText(l, x1 + (x2-x1)/2, y-5);
        }

        if(type === 'newton') {
            let m1X = startX + F1 * scale; let m1Rad = (D * scale) / 2;
            ctx.beginPath(); ctx.arc(m1X - m1Rad*2, axisY, m1Rad*2, -0.25, 0.25); 
            ctx.strokeStyle = C_M1; ctx.lineWidth = 3; ctx.stroke();
            
            ctx.strokeStyle = C_RAY; ctx.lineWidth=1;
            ctx.beginPath(); ctx.moveTo(startX, axisY-m1Rad); ctx.lineTo(m1X, axisY-m1Rad);
            ctx.moveTo(startX, axisY+m1Rad); ctx.lineTo(m1X, axisY+m1Rad); ctx.stroke();
            
            let diagX = m1X - (F1*scale) + (D*1.2*scale);
            ctx.beginPath(); ctx.moveTo(m1X, axisY-m1Rad); ctx.lineTo(diagX, axisY);
            ctx.moveTo(m1X, axisY+m1Rad); ctx.lineTo(diagX, axisY); ctx.stroke();
            
            ctx.beginPath(); ctx.moveTo(diagX-10, axisY-10); ctx.lineTo(diagX+10, axisY+10);
            ctx.strokeStyle=C_M2; ctx.lineWidth=2; ctx.stroke();
            
            ctx.beginPath(); ctx.moveTo(diagX, axisY); ctx.lineTo(diagX, axisY-(D*1.2*scale)); 
            ctx.strokeStyle=theme==='screen'?"#bc13fe":"#000"; ctx.stroke();

            drawDim("F1", diagX, m1X, axisY+m1Rad+30);
        } else {
            let m2X = startX; let m1X = startX + Sep * scale; let focusX = m1X + B * scale;
            let m1Rad = (D*scale)/2; let m2Rad = (D2*scale)/2; let holeRad = (holeDiam*scale)/2;

            let R_draw = m1Rad * 4; let R_cx = m1X - R_draw;
            let aOut = Math.asin(m1Rad/R_draw); let aIn = Math.asin(holeRad/R_draw);
            
            ctx.beginPath(); ctx.arc(R_cx, axisY, R_draw, -aOut, -aIn); ctx.strokeStyle = C_M1; ctx.lineWidth=3; ctx.stroke();
            ctx.beginPath(); ctx.arc(R_cx, axisY, R_draw, aIn, aOut); ctx.strokeStyle = C_M1; ctx.lineWidth=3; ctx.stroke();

            let R2_draw = m2Rad * 4; let R2_cx = m2X - R2_draw; let aM2 = Math.asin(m2Rad/R2_draw);
            ctx.beginPath(); ctx.arc(R2_cx, axisY, R2_draw, -aM2, aM2); ctx.strokeStyle = C_M2; ctx.lineWidth=3; ctx.stroke();

            ctx.strokeStyle = C_RAY;
            ctx.beginPath(); ctx.moveTo(startX-30, axisY-m1Rad); ctx.lineTo(m1X, axisY-m1Rad);
            ctx.moveTo(startX-30, axisY+m1Rad); ctx.lineTo(m1X, axisY+m1Rad); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(m1X, axisY-m1Rad); ctx.lineTo(m2X, axisY-m2Rad);
            ctx.moveTo(m1X, axisY+m1Rad); ctx.lineTo(m2X, axisY+m2Rad); ctx.stroke();
            ctx.strokeStyle = theme==='screen'?"#bc13fe":"#000";
            ctx.beginPath(); ctx.moveTo(m2X, axisY-m2Rad); ctx.lineTo(focusX, axisY);
            ctx.moveTo(m2X, axisY+m2Rad); ctx.lineTo(focusX, axisY); ctx.stroke();

            drawDim("SEPARATION", m2X, m1X, axisY-m1Rad-30);
            drawDim("BACK FOCUS", m1X, focusX, axisY+m1Rad+30);
            
            if(holeDiam>0) {
                let dHx = m1X - 30;
                ctx.beginPath(); ctx.moveTo(dHx, axisY-holeRad); ctx.lineTo(dHx, axisY+holeRad);
                ctx.setLineDash([2,2]); ctx.strokeStyle=theme==='screen'?"rgba(255,255,255,0.3)":"#888"; ctx.lineWidth=1; 
                ctx.moveTo(dHx, axisY-holeRad); ctx.lineTo(m1X, axisY-holeRad);
                ctx.moveTo(dHx, axisY+holeRad); ctx.lineTo(m1X, axisY+holeRad); ctx.stroke(); ctx.setLineDash([]);
                ctx.fillStyle = theme==='screen'?"#ff0055":"#000"; ctx.textAlign="right"; ctx.fillText("√ò "+holeDiam.toFixed(1), dHx-5, axisY+4);
            }
        }
        ctx.restore();
    }

    // --- PDF ---
    function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const pName = document.getElementById('project-name').value || "Projet Optique";
        doc.setFontSize(22); doc.text("LAVAL SOFTWARE // RAPPORT", 20, 20);
        doc.setFontSize(16); doc.setTextColor(0, 86, 179); doc.text(pName, 20, 30);
        doc.setFontSize(10); doc.setTextColor(0,0,0); doc.text("Date: "+new Date().toLocaleDateString(), 150, 20);

        const cvs = document.createElement('canvas'); cvs.width=2000; cvs.height=1000;
        const ctx = cvs.getContext('2d'); ctx.fillStyle="#fff"; ctx.fillRect(0,0,2000,1000);
        
        let oldState = {...viewState}; viewState={scale:1, offsetX:0, offsetY:0};
        drawBlueprintGeneric(ctx, 2000, 1000, currentData.type.toLowerCase(), currentData.D, currentData.F1, currentData.Sep, currentData.B, currentData.D2, currentData.F, currentData.Hole, 'print');
        viewState = oldState;

        doc.addImage(cvs.toDataURL("image/png"), 'PNG', 10, 40, 190, 95);
        
        let y=150; doc.line(10,y,200,y); doc.setFontSize(12); doc.setFont("helvetica","bold"); doc.text("DONN√âES", 10, y-5);
        doc.setFontSize(10); doc.setFont("helvetica","normal");
        doc.text(`Diam√®tre: ${currentData.D} mm`, 15, y+10);
        doc.text(`Diam√®tre Pur: ${currentData.Deff} mm`, 15, y+20);
        doc.text(`Focale: ${currentData.F} mm (f/${(currentData.F/currentData.D).toFixed(1)})`, 15, y+30);
        
        doc.text(`PRIMAIRE (R1): ${currentData.R1.toFixed(2)} mm (K=${currentData.K1.toFixed(4)})`, 80, y+10);
        if(currentData.type!=='NEWTON') {
            doc.text(`SECONDAIRE (R2): ${currentData.R2.toFixed(2)} mm (K=${currentData.K2.toFixed(4)})`, 80, y+20);
            doc.text(`S√©paration: ${currentData.Sep.toFixed(2)} mm`, 80, y+30);
        }
        
        doc.save("Rapport_Optique.pdf");
    }

    function downloadCoursePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Fonction pour ajouter du texte long
        const addWrappedText = (text, x, y, maxWidth, lineHeight) => {
            const lines = doc.splitTextToSize(text, maxWidth);
            doc.text(lines, x, y);
            return lines.length * lineHeight;
        };

        doc.setFontSize(22); doc.setTextColor(0,0,0);
        doc.text("LAVAL SOFTWARE // COURS OPTIQUE", 20, 20);
        
        doc.setFontSize(16); doc.setTextColor(0, 86, 179);
        doc.text("TH√âORIE DE LA CAUSTIQUE & ARCHITECTURE", 20, 35);
        
        doc.setFontSize(12); doc.setTextColor(100, 100, 100);
        doc.text("Auteur : Ludovic Laval", 20, 45);
        
        doc.setFontSize(11); doc.setTextColor(0,0,0);
        let y = 60;
        
        y += addWrappedText("1. LE TEST DE LA CAUSTIQUE (PLATZECK-GAVIOLA)\n\nLes miroirs paraboliques ou hyperboliques ne focalisent pas la lumi√®re en un point unique lorsqu'on les teste depuis leur centre de courbure (contrairement √† une sph√®re). Chaque zone du miroir a un point de convergence diff√©rent. L'ensemble de ces points forme une courbe appel√©e 'Caustique'. Ce logiciel calcule les coordonn√©es exactes (X, Y) o√π vous devez placer votre appareil de mesure (couteau de Foucault) pour v√©rifier chaque zone.", 20, y, 170, 5);
        
        y += 20;
        doc.setFont("helvetica", "bold"); doc.text("2. FORMULES MATH√âMATIQUES", 20, y); y+=10;
        doc.setFont("courier", "normal"); doc.setFontSize(10);
        doc.text("c = 1 / R", 25, y); y+=10;
        doc.text("z = (c * S^2) / (1 + sqrt(1 - (K+1)*c^2*S^2))", 25, y); y+=10;
        doc.text("Y = -K*z * [3 + c*z*(K+1)*(c*z*(K+1)-3)]", 25, y); y+=10;
        doc.text("X = -2*S*c*K*z * [2 + ... ] / (1 - ...)", 25, y); y+=15;
        
        doc.setFont("helvetica", "bold"); doc.setFontSize(11);
        doc.text("3. EXEMPLE DE CALCUL (K=-1, R=6200, S=250)", 20, y); y+=10;
        doc.setFont("helvetica", "normal");
        doc.text("- Courbure c = 0.00016129", 25, y); y+=7;
        doc.text("- Fl√®che z = 5.0403 mm", 25, y); y+=7;
        doc.text("- Position Longitudinale Y = 15.12 mm", 25, y); y+=7;
        doc.text("- Position Transversale X = 0.81 mm", 25, y); y+=15;
        
        doc.setFont("helvetica", "bold");
        doc.text("4. ARCHITECTURE OPTIQUE (Formules de Schwarzschild)", 20, y); y+=10;
        doc.setFont("helvetica", "normal");
        y += addWrappedText("Le module Architecte utilise les √©quations du 3√®me ordre pour √©liminer l'aberration sph√©rique et la coma (pour le Ritchey-Chr√©tien). Pour le Dall-Kirkham, il calcule la d√©formation ellipso√Ødale du primaire (K < 0) n√©cessaire pour compenser un secondaire sph√©rique (K=0).", 20, y, 170, 5);

        doc.save("Cours_Optique_LavalSoftware.pdf");
    }

    // --- CALCULATORS ---
    function runAnalyzer() {
        const D = parseFloat(document.getElementById('an-diameter').value);
        const holeD = parseFloat(document.getElementById('an-hole').value) || 0;
        const R = parseFloat(document.getElementById('an-radius').value);
        const K = parseFloat(document.getElementById('an-kfactor').value);
        const zonesStr = document.getElementById('an-zones').value;
        
        // Validation basique
        if (!zonesStr) return;
        const zones = zonesStr.split(',').map(Number).filter(n=>n);
        
        const tbody = document.getElementById('an-results'); tbody.innerHTML="";
        const c = 1/R;
        
        const cvs = document.getElementById('visualizer'); const ctx = cvs.getContext('2d');
        cvs.width = cvs.parentElement.offsetWidth - 40; cvs.height = 120;
        ctx.clearRect(0,0,cvs.width,cvs.height);
        
        const sc = 50/(D/2); const cx = cvs.width/2; const cy=60;
        ctx.beginPath(); ctx.arc(cx,cy, (D/2)*sc, 0, Math.PI*2); ctx.fillStyle="rgba(255,255,255,0.05)"; ctx.fill(); ctx.strokeStyle="#444"; ctx.stroke();
        
        // Draw Hole
        if(holeD > 0) {
            ctx.beginPath(); ctx.arc(cx, cy, (holeD/2)*sc, 0, Math.PI*2);
            ctx.fillStyle="#000"; ctx.fill(); ctx.strokeStyle="#333"; ctx.stroke();
        }

        zones.forEach(z=>{ ctx.beginPath(); ctx.arc(cx,cy, z*sc, 0, Math.PI*2); ctx.strokeStyle="#00f3ff"; ctx.stroke(); });

        zones.forEach((S,i)=>{
            const term = 1-(K+1)*Math.pow(c*S,2);
            let err = ""; 
            if(S > D/2) err = "HORS MIROIR"; 
            else if(S < holeD/2) err = "DANS TROU";
            else if(term<0) err = "ERR GEOM";

            if(err) tbody.innerHTML+=`<tr><td>${i+1}</td><td>${S}</td><td colspan="3" style="color:red">${err}</td></tr>`;
            else {
                const z = (c*S*S)/(1+Math.sqrt(term));
                const A = c*z*(K+1);
                const Y = -K*z*(3+A*(A-3));
                const X = (-2*S*c*K*z*(2+A*(A-3)))/(1-A);
                tbody.innerHTML+=`<tr><td style="color:#00f3ff">Z${i+1}</td><td>${S}</td><td>${z.toFixed(3)}</td><td>${Y.toFixed(3)}</td><td style="color:#00f3ff; font-weight:bold">${X.toFixed(3)}</td></tr>`;
            }
        });
    }

    function runArchitect() {
        const type = document.getElementById('arch-type').value;
        const D = parseFloat(document.getElementById('arch-D').value);
        const F = parseFloat(document.getElementById('arch-F').value);
        const B = parseFloat(document.getElementById('arch-B').value);
        
        let F1, Separation, M;
        if (type === 'newton') { F1 = F; Separation = 0; M = 1; } 
        else {
            if (calculationMode === 'f1') {
                F1 = parseFloat(document.getElementById('arch-F1').value);
                M = F / F1;
                Separation = (M * F1 - B) / (M + 1);
                document.getElementById('arch-Sep').value = Separation.toFixed(2);
            } else {
                Separation = parseFloat(document.getElementById('arch-Sep').value);
                M = (F - B - Separation) / Separation;
                if (M <= 0) { alert("G√©om√©trie Impossible"); return; }
                F1 = F / M;
                document.getElementById('arch-F1').value = F1.toFixed(2);
            }
        }

        let R1, K1, R2, K2, shape1, shape2, D2, holeDiam;
        R1 = 2 * F1;
        if (type === 'newton') {
            K1 = -1; R2 = 0; K2 = 0; shape1="Parabole"; shape2="Plan"; D2 = D/4; holeDiam=0;
        } else {
            R2 = (2 * Separation * M) / (M - 1);
            D2 = (D * (F1 - Separation)) / F1;
            holeDiam = D2 * (B / (Separation + B));
            if (type === 'cassegrain') { K1 = -1; shape1="Parabole"; const t = (M+1)/(M-1); K2 = -(t*t); shape2="Hyperbole"; } 
            else if (type === 'dk') { K2 = 0; shape2="Sph√®re"; const p = Separation + B; const t = (Math.pow(M, 2) - 1) / Math.pow(M, 3); K1 = -1 + t * (p / F1); shape1 = "Ellipse Prolate"; }
            else if (type === 'rc') { K1 = -1 - (2 * B) / (Math.pow(M, 3) * Separation); K2 = - Math.pow((M+1)/(M-1), 2) - (4*M*(M+1))/((M-1)*Math.pow(M,2)) * (B/Separation); shape1 = "Hyperbole"; shape2 = "Hyperbole"; }
            else if (type === 'sct') { K1 = 0; K2 = 0; shape1="Sph√®re"; shape2="Sph√®re"; }
        }

        let D_obs = (type === 'newton') ? 0 : Math.abs(D2); 
        let Deff = Math.sqrt(Math.pow(D, 2) - Math.pow(D_obs, 2)).toFixed(1);

        currentData = { type: type.toUpperCase(), D: D, F: F, F1: F1, B: B, Sep: Separation, M: M, R1: R1, K1: K1, Shape1: shape1, Hole: holeDiam, R2: Math.abs(R2), K2: K2, Shape2: shape2, D2: Math.abs(D2), Deff: Deff };

        document.getElementById('res-fd').innerText = "f/" + (F/D).toFixed(1);
        document.getElementById('res-mag').innerText = M.toFixed(2) + "x";
        let obst = (Math.abs(D2)/D)*100;
        document.getElementById('res-obst').innerText = obst.toFixed(1) + "%";
        document.getElementById('res-d-eff').innerText = Deff + " mm";

        document.getElementById('res-r1').innerText = R1.toFixed(2);
        document.getElementById('res-f1-out').innerText = F1.toFixed(2);
        document.getElementById('res-k1').innerText = K1.toFixed(4);
        document.getElementById('res-shape1').innerText = shape1;
        document.getElementById('res-hole').innerText = holeDiam > 0 ? holeDiam.toFixed(1) + " mm" : "N/A";

        if(type !== 'newton') {
            document.getElementById('res-r2').innerText = Math.abs(R2).toFixed(2);
            document.getElementById('res-sep-out').innerText = Separation.toFixed(2);
            document.getElementById('res-k2').innerText = K2.toFixed(4);
            document.getElementById('res-d2').innerText = Math.abs(D2).toFixed(1);
        } else {
            document.getElementById('res-r2').innerText = "-";
            document.getElementById('res-sep-out').innerText = "-";
            document.getElementById('res-k2').innerText = "-";
            document.getElementById('res-d2').innerText = "-";
        }
        
        const colMap = { 'dk': '#ff0055', 'rc': '#00f3ff', 'cassegrain': '#ff9d00', 'newton': '#fff', 'sct': '#fff' };
        document.getElementById('res-k1').style.color = colMap[type] || '#fff';

        redrawCurrentBlueprint();
    }

    window.onload = function() { 
        autoCalcZones();
        setTimeout(runArchitect, 100); 
    };
</script>
</body>
</html>
