<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OPTICAL SUITE // LAVAL SOFTWARE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #050510;
            --glass: rgba(20, 20, 35, 0.95);
            --glass-border: rgba(255, 255, 255, 0.1);
            --neon-cyan: #00f3ff;
            --neon-pink: #bc13fe;
            --neon-green: #0f0;
            --neon-orange: #ff9d00;
            --text-main: #e0e0e0;
            --text-dim: #8b9bb4;
        }

        body {
            background-color: var(--bg-dark);
            background-image: 
                linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            color: var(--text-main);
            font-family: 'Rajdhani', sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow-x: hidden;
        }

        .main-wrapper {
            width: 100%;
            max-width: 1400px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .nav-tabs { display: flex; gap: 15px; justify-content: center; }
        .tab-btn {
            background: rgba(0,0,0,0.5); border: 1px solid var(--glass-border); color: var(--text-dim);
            padding: 15px 40px; font-family: 'Orbitron'; font-size: 1.1rem; cursor: pointer; transition: 0.3s;
            clip-path: polygon(15px 0, 100% 0, 100% calc(100% - 15px), calc(100% - 15px) 100%, 0 100%, 0 15px);
        }
        .tab-btn.active { background: var(--neon-cyan); color: #000; font-weight: bold; box-shadow: 0 0 20px rgba(0, 243, 255, 0.3); }

        .interface-container {
            background: var(--glass); backdrop-filter: blur(20px); border: 1px solid var(--glass-border);
            border-radius: 4px; box-shadow: 0 0 50px rgba(0, 0, 0, 0.9); display: grid;
            grid-template-columns: 360px 1fr; overflow: hidden; min-height: 850px; display: none;
            clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px);
        }
        .interface-container.active { display: grid; }

        .controls {
            padding: 30px; border-right: 1px solid var(--glass-border); background: rgba(0, 0, 0, 0.3);
            display: flex; flex-direction: column; gap: 18px; overflow-y: auto; z-index: 2;
        }
        .brand { font-family: 'Orbitron', sans-serif; font-size: 1.5rem; color: #fff; border-bottom: 2px solid var(--neon-cyan); padding-bottom: 15px; margin-bottom: 10px; }
        .brand span { color: var(--neon-pink); }

        .input-group label { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-dim); margin-bottom: 5px; text-transform: uppercase; }
        .input-group input, .input-group select { width: 100%; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--glass-border); color: #fff; padding: 12px; font-family: 'Orbitron'; font-size: 1rem; }
        .input-group input:disabled { background: rgba(0,0,0,0.5); color: #555; cursor: not-allowed; }

        .mode-switch { display: flex; background: rgba(0,0,0,0.5); padding: 4px; border-radius: 4px; margin-bottom: 10px; }
        .mode-option { flex: 1; text-align: center; padding: 8px; font-size: 0.75rem; cursor: pointer; color: var(--text-dim); font-family: 'Orbitron'; }
        .mode-option.active { background: var(--neon-pink); color: white; font-weight: bold; }

        .btn-action { background: linear-gradient(90deg, var(--neon-cyan), #0088ff); color: #000; border: none; padding: 15px; font-family: 'Orbitron'; font-weight: bold; cursor: pointer; margin-top: auto; text-transform: uppercase; }
        .btn-action:hover { box-shadow: 0 0 20px var(--neon-cyan); letter-spacing: 2px; }
        
        .btn-pdf { background: #fff; color: #000; border: none; padding: 15px; font-family: 'Orbitron'; font-weight: bold; cursor: pointer; margin-top: 10px; text-transform: uppercase; }
        .btn-pdf:hover { background: #eee; box-shadow: 0 0 15px #fff; }

        .auto-zone-group { display: flex; gap: 10px; align-items: flex-end; margin-bottom: 10px; }
        .btn-auto { background: transparent; border: 1px solid var(--neon-pink); color: var(--neon-pink); padding: 12px; font-family: 'Orbitron'; font-size: 0.8rem; cursor: pointer; flex: 2; transition: 0.3s; }
        .btn-auto:hover { background: var(--neon-pink); color: #fff; box-shadow: 0 0 15px var(--neon-pink); }
        .input-small { width: 80px !important; text-align: center; }

        .results-panel { padding: 40px; position: relative; background: radial-gradient(circle at top right, rgba(0,50,100,0.15), transparent); overflow-y: auto; display: flex; flex-direction: column; }

        .blueprint-wrapper {
            position: relative;
            width: 100%; height: 450px;
            background: #080810;
            border: 1px solid var(--glass-border);
            margin-bottom: 20px;
            overflow: hidden; 
        }
        
        #blueprint-canvas { width: 100%; height: 100%; display: block; cursor: grab; }
        #blueprint-canvas:active { cursor: grabbing; }

        .zoom-controls { position: absolute; bottom: 20px; right: 20px; display: flex; gap: 5px; }
        .zoom-btn { width: 30px; height: 30px; background: rgba(0,0,0,0.7); color: #fff; border: 1px solid var(--neon-cyan); font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .zoom-btn:hover { background: var(--neon-cyan); color: #000; }

        .arch-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .mirror-card { background: rgba(255,255,255,0.02); border: 1px solid var(--glass-border); padding: 25px; }
        .mirror-card h3 { margin: 0 0 20px 0; font-family: 'Orbitron'; font-size: 1rem; color: var(--text-dim); border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px;}
        .res-val { font-family: 'Orbitron'; color: #fff; font-size: 1.2rem; text-align: right; }
        .result-row { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 5px; font-size: 0.9rem;}

        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .data-table th { text-align: left; color: var(--text-dim); padding: 10px; border-bottom: 1px solid var(--neon-cyan); }
        .data-table td { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }

        .footer-brand { position: fixed; bottom: 10px; right: 20px; font-family: 'Orbitron'; font-size: 0.7rem; color: rgba(255,255,255,0.3); }
        #an-info { margin-bottom: 20px; display: flex; gap: 20px; font-size: 0.9rem; color: var(--text-dim); }
        #an-info span { color: #fff; font-family: 'Orbitron'; margin-left: 5px; }
    </style>
</head>
<body>

<div class="main-wrapper">
    <div class="nav-tabs">
        <div class="tab-btn active" onclick="switchTab('analyzer')">ANALYSEUR CAUSTIQUE</div>
        <div class="tab-btn" onclick="switchTab('architect')">ARCHITECTE OPTIQUE</div>
    </div>

    <!-- MODULE ANALYZER -->
    <div id="analyzer" class="interface-container active">
        <div class="controls">
            <div class="brand">CAUSTIQUE <span>v18</span></div>
            
            <div class="input-group">
                <label>Type de Miroir</label>
                <select id="an-type" onchange="updateAnalyzerK()">
                    <option value="parabola" selected>Parabole (K = -1)</option>
                    <option value="hyperbola">Hyperbole (K < -1)</option>
                    <option value="sphere">SphÃ¨re (K = 0)</option>
                    <option value="ellipse">Ellipse (-1 < K < 0)</option>
                    <option value="custom">PersonnalisÃ©</option>
                </select>
            </div>

            <div class="input-group"><label>DiamÃ¨tre Miroir (mm)</label><input type="number" id="an-diameter" value="300"></div>
            <div class="input-group"><label>Rayon Courbure (R)</label><input type="number" id="an-radius" value="6200" step="0.1"></div>
            <div class="input-group"><label>Constante (K)</label><input type="number" id="an-kfactor" value="-1" step="0.0001"></div>
            
            <label style="color:var(--text-dim); font-size:0.8rem; margin-top:10px; display:block;">GÃ‰NÃ‰RATEUR DE ZONES</label>
            <div class="auto-zone-group">
                <div style="flex:1;">
                    <label style="font-size:0.7rem;">NB. ZONES</label>
                    <input type="number" id="an-nb-zones" class="input-small" placeholder="Auto">
                </div>
                <button class="btn-auto" onclick="autoCalcZones()">CALCULER</button>
            </div>

            <div class="input-group">
                <label>Liste des Rayons (mm)</label>
                <input type="text" id="an-zones" value="50, 100, 140, 200">
            </div>
            
            <button class="btn-action" onclick="runAnalyzer()">Lancer Analyse</button>
        </div>
        <div class="results-panel">
            <div id="an-info">
                <div>F/D: <span id="an-fd">-</span></div>
                <div>Largeur Zone Max: <span id="an-maxw" style="color:var(--neon-pink)">-</span></div>
            </div>
            <canvas id="visualizer" style="width:100%; height:120px; background:rgba(0,0,0,0.2); border:1px solid #333; margin-bottom:20px;"></canvas>
            <table class="data-table">
                <thead><tr><th>ZONE</th><th>RAYON (S)</th><th>PROF. (Z)</th><th>AXIAL (Y)</th><th>TRANSV. (X)</th></tr></thead>
                <tbody id="an-results"></tbody>
            </table>
        </div>
    </div>

    <!-- MODULE ARCHITECT -->
    <div id="architect" class="interface-container">
        <div class="controls">
            <div class="brand">ARCHITECT <span>PRO</span></div>
            
            <div class="input-group">
                <label>Architecture</label>
                <select id="arch-type" onchange="updateArchUI()">
                    <option value="newton">Newton (Parabolique)</option>
                    <option value="cassegrain">Cassegrain Classique</option>
                    <option value="dk">Dall-Kirkham (DK)</option>
                    <option value="rc" selected>Ritchey-ChrÃ©tien (RC)</option>
                    <option value="sct">Schmidt-Cassegrain (SCT)</option>
                </select>
            </div>

            <div class="input-group"><label>DiamÃ¨tre (D) mm</label><input type="number" id="arch-D" value="300"></div>
            <div class="input-group"><label>Focale SystÃ¨me (F) mm</label><input type="number" id="arch-F" value="4500"></div>
            <div class="input-group"><label>Back Focus (B) mm</label><input type="number" id="arch-B" value="300"></div>

            <div id="calc-mode-container">
                <label style="color:var(--text-dim); font-size:0.7rem; margin-bottom:5px;">CONTRAINTE</label>
                <div class="mode-switch">
                    <div class="mode-option active" id="mode-f1" onclick="setCalcMode('f1')">FIXER FOCALE F1</div>
                    <div class="mode-option" id="mode-sep" onclick="setCalcMode('sep')">FIXER SÃ‰PARATION</div>
                </div>
            </div>

            <div class="input-group"><label>Focale Primaire (F1) <span id="lock-f1">ðŸ”’</span></label><input type="number" id="arch-F1" value="900"></div>
            <div class="input-group"><label>SÃ©paration (d) <span id="lock-sep" style="display:none">ðŸ”’</span></label><input type="number" id="arch-Sep" value="650" disabled></div>

            <button class="btn-action" onclick="runArchitect()">CALCULER & DESSINER</button>
            
            <div class="pdf-group">
                <div class="input-group">
                    <label>Nom du Projet</label>
                    <input type="text" id="project-name" placeholder="Ex: Mon Dall-Kirkham 300">
                </div>
                <button class="btn-pdf" onclick="downloadPDF()">TÃ‰LÃ‰CHARGER LE PLAN (PDF)</button>
            </div>
        </div>

        <div class="results-panel">
            <div style="font-family:'Orbitron'; font-size:1.2rem; color:var(--text-dim); margin-bottom:10px;">PLAN TECHNIQUE</div>
            
            <div class="blueprint-wrapper">
                <canvas id="blueprint-canvas"></canvas>
                <div class="zoom-controls">
                    <div class="zoom-btn" onclick="zoomBlueprint(0.1)">+</div>
                    <div class="zoom-btn" onclick="zoomBlueprint(-0.1)">-</div>
                    <div class="zoom-btn" onclick="resetZoom()">R</div>
                </div>
            </div>
            
            <div style="display:flex; justify-content:space-between; margin-bottom:20px; border-bottom:1px solid var(--glass-border); padding-bottom:10px;">
                <div><div style="font-size:0.8rem; color:var(--text-dim)">OUVERTURE</div><div style="font-family:'Orbitron'; font-size:1.2rem; color:#fff" id="res-fd">-</div></div>
                <div><div style="font-size:0.8rem; color:var(--text-dim)">GRANDISSEMENT</div><div style="font-family:'Orbitron'; font-size:1.2rem; color:#fff" id="res-mag">-</div></div>
                <div><div style="font-size:0.8rem; color:var(--text-dim)">OBSTRUCTION</div><div style="font-family:'Orbitron'; font-size:1.2rem; color:#fff" id="res-obst">-</div></div>
                <div><div style="font-size:0.8rem; color:var(--text-dim)">DIAMÃˆTRE PUR</div><div style="font-family:'Orbitron'; font-size:1.2rem; color:var(--neon-cyan)" id="res-d-eff">-</div></div>
            </div>

            <div class="arch-grid">
                <div class="mirror-card">
                    <h3 style="color:var(--neon-orange)">MIROIR PRIMAIRE</h3>
                    <div class="result-row"><span>Rayon Courbure (R1)</span><div class="res-val" id="res-r1">-</div></div>
                    <div class="result-row"><span>Focale (F1)</span><div class="res-val" id="res-f1-out">-</div></div>
                    <div class="result-row"><span>Constante (K1)</span><div class="res-val" id="res-k1">-</div></div>
                    <div class="result-row"><span>Forme</span><div class="res-val" id="res-shape1" style="font-size:0.8rem">-</div></div>
                    <div class="result-row"><span>Trou Central (Min)</span><div class="res-val" id="res-hole" style="color:var(--neon-pink)">-</div></div>
                </div>

                <div class="mirror-card" id="sec-card">
                    <h3 style="color:var(--neon-green)">MIROIR SECONDAIRE</h3>
                    <div class="result-row"><span>Rayon Courbure (R2)</span><div class="res-val" id="res-r2">-</div></div>
                    <div class="result-row"><span>SÃ©paration (d)</span><div class="res-val" id="res-sep-out">-</div></div>
                    <div class="result-row"><span>Constante (K2)</span><div class="res-val" id="res-k2">-</div></div>
                    <div class="result-row"><span>DiamÃ¨tre Optique</span><div class="res-val" id="res-d2">-</div></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="footer-brand">LAVAL SOFTWARE // OPTICAL SUITE v18</div>
</div>

<script>
    let currentData = {};
    let viewState = { scale: 1, offsetX: 0, offsetY: 0, isDragging: false, lastX: 0, lastY: 0 };
    let calculationMode = 'f1';

    // --- ANALYZEUR: CALCUL AUTO ZONES ---
    function autoCalcZones() {
        const D = parseFloat(document.getElementById('an-diameter').value);
        const R = parseFloat(document.getElementById('an-radius').value);
        const forcedN = parseInt(document.getElementById('an-nb-zones').value);
        
        if(!D || !R) { alert("Veuillez saisir DiamÃ¨tre et Rayon."); return; }

        const m = (R/2) / D;
        const R_cm = R / 10;
        
        // Largeur max thÃ©orique
        const term = m * Math.pow(R_cm, 2);
        const width_cm = 4.53 * Math.pow(term, 1/3) * 0.01;
        const width_mm = width_cm * 10;

        const radiusMirror = D / 2;
        let numZones;

        // Si l'utilisateur force le nombre
        if (forcedN > 0) {
            numZones = forcedN;
        } else {
            // Sinon, calcul optimal
            numZones = Math.ceil(radiusMirror / width_mm);
            // On met Ã  jour l'input pour info
            document.getElementById('an-nb-zones').value = numZones;
        }

        const actualWidth = radiusMirror / numZones;
        let zoneCenters = [];
        
        for(let i=0; i<numZones; i++) {
            let center = (i * actualWidth) + (actualWidth/2);
            if(center > 10) zoneCenters.push(center.toFixed(1));
        }

        document.getElementById('an-zones').value = zoneCenters.join(', ');
        document.getElementById('an-fd').innerText = "f/" + m.toFixed(1);
        document.getElementById('an-maxw').innerText = width_mm.toFixed(1) + " mm";
        
        runAnalyzer();
    }

    // --- BLUEPRINT ZOOM ---
    const canvas = document.getElementById('blueprint-canvas');
    canvas.addEventListener('mousedown', (e) => { viewState.isDragging = true; viewState.lastX = e.clientX; viewState.lastY = e.clientY; });
    window.addEventListener('mouseup', () => { viewState.isDragging = false; });
    canvas.addEventListener('mousemove', (e) => {
        if (!viewState.isDragging) return;
        viewState.offsetX += e.clientX - viewState.lastX;
        viewState.offsetY += e.clientY - viewState.lastY;
        viewState.lastX = e.clientX; viewState.lastY = e.clientY;
        redrawCurrentBlueprint();
    });
    canvas.addEventListener('wheel', (e) => {
        e.preventDefault();
        zoomBlueprint(e.deltaY > 0 ? -0.1 : 0.1);
    });

    function zoomBlueprint(delta) {
        viewState.scale += delta;
        if(viewState.scale < 0.1) viewState.scale = 0.1;
        if(viewState.scale > 5) viewState.scale = 5;
        redrawCurrentBlueprint();
    }
    function resetZoom() { viewState.scale = 1; viewState.offsetX = 0; viewState.offsetY = 0; redrawCurrentBlueprint(); }
    function redrawCurrentBlueprint() {
        if(!currentData.type) return;
        const ctx = canvas.getContext('2d');
        drawBlueprintGeneric(ctx, canvas.width, canvas.height, currentData.type.toLowerCase(), currentData.D, currentData.F1, currentData.Sep, currentData.B, currentData.D2, currentData.F, currentData.Hole, 'screen');
    }

    // --- UI LOGIC ---
    function switchTab(tabId) {
        document.querySelectorAll('.interface-container').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        event.target.classList.add('active');
        if(tabId === 'architect') { canvas.width = canvas.parentElement.offsetWidth; canvas.height = canvas.parentElement.offsetHeight; setTimeout(runArchitect, 50); }
    }

    function setCalcMode(mode) {
        calculationMode = mode;
        const inpF1 = document.getElementById('arch-F1');
        const inpSep = document.getElementById('arch-Sep');
        const lockF1 = document.getElementById('lock-f1');
        const lockSep = document.getElementById('lock-sep');
        const btnF1 = document.getElementById('mode-f1');
        const btnSep = document.getElementById('mode-sep');
        if(mode === 'f1') {
            btnF1.classList.add('active'); btnSep.classList.remove('active');
            inpF1.disabled = false; inpSep.disabled = true;
            lockF1.style.display = 'inline'; lockSep.style.display = 'none';
        } else {
            btnF1.classList.remove('active'); btnSep.classList.add('active');
            inpF1.disabled = true; inpSep.disabled = false;
            lockF1.style.display = 'none'; lockSep.style.display = 'inline';
        }
    }

    function updateArchUI() {
        const type = document.getElementById('arch-type').value;
        const modeDiv = document.getElementById('calc-mode-container');
        const inpSep = document.getElementById('arch-Sep');
        if(type === 'newton') {
            modeDiv.style.opacity = '0.3'; modeDiv.style.pointerEvents = 'none'; setCalcMode('f1');
            document.getElementById('sec-card').style.opacity = '0.3'; inpSep.value = "0";
        } else {
            modeDiv.style.opacity = '1'; modeDiv.style.pointerEvents = 'all'; document.getElementById('sec-card').style.opacity = '1';
        }
        runArchitect();
    }

    function updateAnalyzerK() {
        const type = document.getElementById('an-type').value;
        const kInput = document.getElementById('an-kfactor');
        if(type === 'parabola') kInput.value = -1;
        else if(type === 'sphere') kInput.value = 0;
        else if(type === 'hyperbola') kInput.value = -1.1;
        else if(type === 'ellipse') kInput.value = -0.5;
    }

    // --- BLUEPRINT DRAWING ---
    function drawBlueprintGeneric(ctx, width, height, type, D, F1, Sep, B, D2, F_sys, holeDiam, theme) {
        ctx.clearRect(0,0, width, height);
        ctx.save();
        if(theme === 'screen') {
            ctx.translate(viewState.offsetX, viewState.offsetY);
            ctx.translate(width/2, height/2);
            ctx.scale(viewState.scale, viewState.scale);
            ctx.translate(-width/2, -height/2);
        }

        const C_M1 = theme==='screen'?"#ff9d00":"#000";
        const C_M2 = theme==='screen'?"#0f0":"#000";
        const C_DIM = theme==='screen'?"#00f3ff":"#444";
        const C_TEXT = theme==='screen'?"#fff":"#000";
        const C_RAY = theme==='screen'?"rgba(0, 243, 255, 0.4)":"#aaa";

        let totalLen = (type === 'newton') ? F1 * 1.3 : (Sep + B) * 1.2;
        let scale = (width - 120) / totalLen; 
        let startX = 60; let axisY = height / 2;

        ctx.beginPath(); ctx.moveTo(-1000, axisY); ctx.lineTo(width+1000, axisY);
        ctx.setLineDash([5, 5]); ctx.strokeStyle = theme==='screen'?"rgba(255,255,255,0.1)":"#ccc"; ctx.stroke(); ctx.setLineDash([]);

        function drawDim(l, x1, x2, y) {
            ctx.beginPath(); ctx.moveTo(x1, y); ctx.lineTo(x2, y);
            ctx.moveTo(x1, y-5); ctx.lineTo(x1, y+5); ctx.moveTo(x2, y-5); ctx.lineTo(x2, y+5);
            ctx.strokeStyle = C_DIM; ctx.lineWidth=1/viewState.scale; ctx.stroke();
            ctx.fillStyle = C_TEXT; ctx.font = theme==='screen'?"12px Orbitron":"10px Helvetica"; ctx.textAlign="center";
            ctx.fillText(l, x1 + (x2-x1)/2, y-5);
        }

        if(type === 'newton') {
            let m1X = startX + F1 * scale; let m1Rad = (D * scale) / 2;
            ctx.beginPath(); ctx.arc(m1X - m1Rad*2, axisY, m1Rad*2, -0.25, 0.25); 
            ctx.strokeStyle = C_M1; ctx.lineWidth = 3; ctx.stroke();
            
            ctx.strokeStyle = C_RAY; ctx.lineWidth=1;
            ctx.beginPath(); ctx.moveTo(startX, axisY-m1Rad); ctx.lineTo(m1X, axisY-m1Rad);
            ctx.moveTo(startX, axisY+m1Rad); ctx.lineTo(m1X, axisY+m1Rad); ctx.stroke();
            
            let diagX = m1X - (F1*scale) + (D*1.2*scale);
            ctx.beginPath(); ctx.moveTo(m1X, axisY-m1Rad); ctx.lineTo(diagX, axisY);
            ctx.moveTo(m1X, axisY+m1Rad); ctx.lineTo(diagX, axisY); ctx.stroke();
            
            ctx.beginPath(); ctx.moveTo(diagX-10, axisY-10); ctx.lineTo(diagX+10, axisY+10);
            ctx.strokeStyle=C_M2; ctx.lineWidth=2; ctx.stroke();
            
            ctx.beginPath(); ctx.moveTo(diagX, axisY); ctx.lineTo(diagX, axisY-(D*1.2*scale)); 
            ctx.strokeStyle=theme==='screen'?"#bc13fe":"#000"; ctx.stroke();

            drawDim("F1", diagX, m1X, axisY+m1Rad+30);
        } else {
            let m2X = startX; let m1X = startX + Sep * scale; let focusX = m1X + B * scale;
            let m1Rad = (D*scale)/2; let m2Rad = (D2*scale)/2; let holeRad = (holeDiam*scale)/2;

            let R_draw = m1Rad * 4; let R_cx = m1X - R_draw;
            let aOut = Math.asin(m1Rad/R_draw); let aIn = Math.asin(holeRad/R_draw);
            
            ctx.beginPath(); ctx.arc(R_cx, axisY, R_draw, -aOut, -aIn); ctx.strokeStyle = C_M1; ctx.lineWidth=3; ctx.stroke();
            ctx.beginPath(); ctx.arc(R_cx, axisY, R_draw, aIn, aOut); ctx.strokeStyle = C_M1; ctx.lineWidth=3; ctx.stroke();

            let R2_draw = m2Rad * 4; let R2_cx = m2X - R2_draw; let aM2 = Math.asin(m2Rad/R2_draw);
            ctx.beginPath(); ctx.arc(R2_cx, axisY, R2_draw, -aM2, aM2); ctx.strokeStyle = C_M2; ctx.lineWidth=3; ctx.stroke();

            ctx.strokeStyle = C_RAY;
            ctx.beginPath(); ctx.moveTo(startX-30, axisY-m1Rad); ctx.lineTo(m1X, axisY-m1Rad);
            ctx.moveTo(startX-30, axisY+m1Rad); ctx.lineTo(m1X, axisY+m1Rad); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(m1X, axisY-m1Rad); ctx.lineTo(m2X, axisY-m2Rad);
            ctx.moveTo(m1X, axisY+m1Rad); ctx.lineTo(m2X, axisY+m2Rad); ctx.stroke();
            
            ctx.strokeStyle = theme==='screen'?"#bc13fe":"#000";
            ctx.beginPath(); ctx.moveTo(m2X, axisY-m2Rad); ctx.lineTo(focusX, axisY);
            ctx.moveTo(m2X, axisY+m2Rad); ctx.lineTo(focusX, axisY); ctx.stroke();

            drawDim("SEPARATION", m2X, m1X, axisY-m1Rad-30);
            drawDim("BACK FOCUS", m1X, focusX, axisY+m1Rad+30);
            
            if(holeDiam>0) {
                let dHx = m1X - 30;
                ctx.beginPath(); ctx.moveTo(dHx, axisY-holeRad); ctx.lineTo(dHx, axisY+holeRad);
                ctx.setLineDash([2,2]); ctx.strokeStyle=theme==='screen'?"rgba(255,255,255,0.3)":"#888"; ctx.lineWidth=1; 
                ctx.moveTo(dHx, axisY-holeRad); ctx.lineTo(m1X, axisY-holeRad);
                ctx.moveTo(dHx, axisY+holeRad); ctx.lineTo(m1X, axisY+holeRad); ctx.stroke(); ctx.setLineDash([]);
                ctx.fillStyle = theme==='screen'?"#ff0055":"#000"; ctx.textAlign="right"; ctx.fillText("Ã˜ "+holeDiam.toFixed(1), dHx-5, axisY+4);
            }
        }
        ctx.restore();
    }

    function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const pName = document.getElementById('project-name').value || "Projet Optique";
        doc.setFontSize(22); doc.text("LAVAL SOFTWARE // RAPPORT", 20, 20);
        doc.setFontSize(16); doc.setTextColor(0, 86, 179); doc.text(pName, 20, 30);
        doc.setFontSize(10); doc.setTextColor(0,0,0); doc.text("Date: "+new Date().toLocaleDateString(), 150, 20);

        const cvs = document.createElement('canvas'); cvs.width=2000; cvs.height=1000;
        const ctx = cvs.getContext('2d'); ctx.fillStyle="#fff"; ctx.fillRect(0,0,2000,1000);
        
        let oldState = {...viewState}; viewState={scale:1, offsetX:0, offsetY:0};
        drawBlueprintGeneric(ctx, 2000, 1000, currentData.type.toLowerCase(), currentData.D, currentData.F1, currentData.Sep, currentData.B, currentData.D2, currentData.F, currentData.Hole, 'print');
        viewState = oldState;

        doc.addImage(cvs.toDataURL("image/png"), 'PNG', 10, 40, 190, 95);
        
        let y=150; doc.line(10,y,200,y); doc.setFontSize(12); doc.setFont("helvetica","bold"); doc.text("DONNÃ‰ES", 10, y-5);
        doc.setFontSize(10); doc.setFont("helvetica","normal");
        doc.text(`DiamÃ¨tre: ${currentData.D} mm`, 15, y+10);
        doc.text(`DiamÃ¨tre Pur: ${currentData.Deff} mm`, 15, y+20);
        doc.text(`Focale: ${currentData.F} mm (f/${(currentData.F/currentData.D).toFixed(1)})`, 15, y+30);
        
        doc.text(`PRIMAIRE (R1): ${currentData.R1.toFixed(2)} mm (K=${currentData.K1.toFixed(4)})`, 80, y+10);
        if(currentData.type!=='NEWTON') {
            doc.text(`SECONDAIRE (R2): ${currentData.R2.toFixed(2)} mm (K=${currentData.K2.toFixed(4)})`, 80, y+20);
            doc.text(`SÃ©paration: ${currentData.Sep.toFixed(2)} mm`, 80, y+30);
        }
        
        doc.save("Rapport_Optique.pdf");
    }

    function runAnalyzer() {
        const D = parseFloat(document.getElementById('an-diameter').value);
        const R = parseFloat(document.getElementById('an-radius').value);
        const K = parseFloat(document.getElementById('an-kfactor').value);
        const zones = document.getElementById('an-zones').value.split(',').map(Number).filter(n=>n);
        const tbody = document.getElementById('an-results'); tbody.innerHTML="";
        const c = 1/R;
        
        const cvs = document.getElementById('visualizer'); const ctx = cvs.getContext('2d');
        cvs.width = cvs.parentElement.offsetWidth - 40; cvs.height = 120;
        ctx.clearRect(0,0,cvs.width,cvs.height);
        
        const sc = 50/(D/2); const cx = cvs.width/2; const cy=60;
        ctx.beginPath(); ctx.arc(cx,cy, (D/2)*sc, 0, Math.PI*2); ctx.fillStyle="rgba(255,255,255,0.05)"; ctx.fill(); ctx.strokeStyle="#444"; ctx.stroke();
        zones.forEach(z=>{ ctx.beginPath(); ctx.arc(cx,cy, z*sc, 0, Math.PI*2); ctx.strokeStyle="#00f3ff"; ctx.stroke(); });

        zones.forEach((S,i)=>{
            const term = 1-(K+1)*Math.pow(c*S,2);
            let err = "";
            if(S > D/2) err = "HORS MIROIR";
            else if(term<0) err = "ERR GEOM";

            if(err) tbody.innerHTML+=`<tr><td>${i+1}</td><td>${S}</td><td colspan="3" style="color:red">${err}</td></tr>`;
            else {
                const z = (c*S*S)/(1+Math.sqrt(term));
                const A = c*z*(K+1);
                const Y = -K*z*(3+A*(A-3));
                const X = (-2*S*c*K*z*(2+A*(A-3)))/(1-A);
                tbody.innerHTML+=`<tr><td style="color:#00f3ff">Z${i+1}</td><td>${S}</td><td>${z.toFixed(3)}</td><td>${Y.toFixed(3)}</td><td style="color:#00f3ff; font-weight:bold">${X.toFixed(3)}</td></tr>`;
            }
        });
    }

    function runArchitect() {
        const type = document.getElementById('arch-type').value;
        const D = parseFloat(document.getElementById('arch-D').value);
        const F = parseFloat(document.getElementById('arch-F').value);
        const B = parseFloat(document.getElementById('arch-B').value);
        
        let F1, Separation, M;
        if (type === 'newton') { F1 = F; Separation = 0; M = 1; } 
        else {
            if (calculationMode === 'f1') {
                F1 = parseFloat(document.getElementById('arch-F1').value);
                M = F / F1;
                Separation = (M * F1 - B) / (M + 1);
                document.getElementById('arch-Sep').value = Separation.toFixed(2);
            } else {
                Separation = parseFloat(document.getElementById('arch-Sep').value);
                M = (F - B - Separation) / Separation;
                if (M <= 0) { alert("GÃ©omÃ©trie Impossible"); return; }
                F1 = F / M;
                document.getElementById('arch-F1').value = F1.toFixed(2);
            }
        }

        let R1, K1, R2, K2, shape1, shape2, D2, holeDiam;
        R1 = 2 * F1;
        if (type === 'newton') {
            K1 = -1; R2 = 0; K2 = 0; shape1="Parabole"; shape2="Plan"; D2 = D/4; holeDiam=0;
        } else {
            R2 = (2 * Separation * M) / (M - 1);
            D2 = (D * (F1 - Separation)) / F1;
            holeDiam = D2 * (B / (Separation + B));
            if (type === 'cassegrain') { K1 = -1; shape1="Parabole"; const t = (M+1)/(M-1); K2 = -(t*t); shape2="Hyperbole"; } 
            else if (type === 'dk') { K2 = 0; shape2="SphÃ¨re"; const p = Separation + B; const t = (Math.pow(M, 2) - 1) / Math.pow(M, 3); K1 = -1 + t * (p / F1); shape1 = "Ellipse Prolate"; }
            else if (type === 'rc') { K1 = -1 - (2 * B) / (Math.pow(M, 3) * Separation); K2 = - Math.pow((M+1)/(M-1), 2) - (4*M*(M+1))/((M-1)*Math.pow(M,2)) * (B/Separation); shape1 = "Hyperbole"; shape2 = "Hyperbole"; }
            else if (type === 'sct') { K1 = 0; K2 = 0; shape1="SphÃ¨re"; shape2="SphÃ¨re"; }
        }

        let D_obs = (type === 'newton') ? 0 : Math.abs(D2); 
        let Deff = Math.sqrt(Math.pow(D, 2) - Math.pow(D_obs, 2)).toFixed(1);

        currentData = { type: type.toUpperCase(), D: D, F: F, F1: F1, B: B, Sep: Separation, M: M, R1: R1, K1: K1, Shape1: shape1, Hole: holeDiam, R2: Math.abs(R2), K2: K2, Shape2: shape2, D2: Math.abs(D2), Deff: Deff };

        document.getElementById('res-fd').innerText = "f/" + (F/D).toFixed(1);
        document.getElementById('res-mag').innerText = M.toFixed(2) + "x";
        let obst = (Math.abs(D2)/D)*100;
        document.getElementById('res-obst').innerText = obst.toFixed(1) + "%";
        document.getElementById('res-d-eff').innerText = Deff + " mm";

        document.getElementById('res-r1').innerText = R1.toFixed(2);
        document.getElementById('res-f1-out').innerText = F1.toFixed(2);
        document.getElementById('res-k1').innerText = K1.toFixed(4);
        document.getElementById('res-shape1').innerText = shape1;
        document.getElementById('res-hole').innerText = holeDiam > 0 ? holeDiam.toFixed(1) + " mm" : "N/A";

        if(type !== 'newton') {
            document.getElementById('res-r2').innerText = Math.abs(R2).toFixed(2);
            document.getElementById('res-sep-out').innerText = Separation.toFixed(2);
            document.getElementById('res-k2').innerText = K2.toFixed(4);
            document.getElementById('res-d2').innerText = Math.abs(D2).toFixed(1);
        } else {
            document.getElementById('res-r2').innerText = "-";
            document.getElementById('res-sep-out').innerText = "-";
            document.getElementById('res-k2').innerText = "-";
            document.getElementById('res-d2').innerText = "-";
        }
        
        const colMap = { 'dk': '#ff0055', 'rc': '#00f3ff', 'cassegrain': '#ff9d00', 'newton': '#fff', 'sct': '#fff' };
        document.getElementById('res-k1').style.color = colMap[type] || '#fff';

        redrawCurrentBlueprint();
    }

    window.onload = function() { 
        autoCalcZones();
        setTimeout(runArchitect, 100); 
    };
</script>
</body>
</html>
